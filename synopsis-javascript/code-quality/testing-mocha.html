<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial=scale=1.0">

  <title>Автоматическое тестирование c использованием фреймворка Mocha</title>
  
  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="../css/fonts.css">
  <link rel="shortcut icon" href="../img/iconfinder_graduation_cap.png">
</head>

<body>
  <div class="page-wrapper">
    <div class="page">
      <div class="main__header">
        <div class="main__header-group">
          <ol class="breadcrumbs">
            <li class="breadcrumbs__item breadcrumbs__item_home">
              <a class="breadcrumbs__link" title="Оглавление" href="../index.html"></a>
            </li>
            <li class="breadcrumbs__item"></li>
          </ol>
          <div class="updated-at">
            <div class="updated-at__content">5-го июля 2020</div>
          </div>
        </div>
        <h1 class="page__title">Автоматическое тестирование c использованием фреймворка Mocha</h1>
      </div>
      <div itemprop="articleBody">
        <p>Далее у нас будут задачи, для проверки которых используется автоматическое тестирование. Также его часто применяют в реальных проектах.</p>
        <h2>Зачем нам нужны тесты?</h2>
        <p>Обычно, когда мы пишем функцию, мы легко можем представить, что она должна делать, и как она будет вести себя в зависимости от переданных параметров.</p>
        <p>Во время разработки мы можем проверить правильность работы функции, просто вызвав её, например, из консоли и сравнив полученный результат с ожидаемым.</p>
        <p>Если функция работает не так, как мы ожидаем, то можно внести исправления в код и запустить её ещё раз. Так можно повторять до тех пор, пока функция не станет работать так, как нам нужно.</p>
        <p>Однако, такие «ручные перезапуски» – не лучшее решение.</p>
        <p><strong>При тестировании кода ручными перезапусками легко упустить что-нибудь важное.</strong></p>
        <p>Например, мы работаем над функцией <code>f</code>. Написали часть кода и решили протестировать. Выясняется, что <code>f(1)</code> работает правильно, в то время как <code>f(2)</code> – нет. Мы вносим в код исправления, и теперь <code>f(2)</code> работает правильно. Вроде бы, всё хорошо, не так ли? Однако, мы забыли заново протестировать <code>f(1)</code>. Возможно, после внесения правок <code>f(1)</code> стала работать неправильно.</p>
        <p>Это – типичная ситуация. Во время разработки мы учитываем множество различных сценариев использования. Но сложно ожидать, что программист станет вручную проверять каждый из них после любого изменения кода. Поэтому легко исправить что-то одно и при этом сломать что-то другое.</p>
        <p><strong>Автоматическое тестирование означает, что тесты пишутся отдельно, в дополнение к коду. Они по-разному запускают наши функции и сравнивают результат с ожидаемым.</strong></p>
        <h2>Behavior Driven Development (BDD)</h2>
        <p>Давайте начнём с техники под названием <a href="https://ru.wikipedia.org/wiki/BDD_(%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5)">Behavior Driven Development</a> или, коротко, BDD.</p>
        <p><strong>BDD – это три в одном: и тесты, и документация, и примеры использования.</strong></p>
        <p>Чтобы понять BDD – рассмотрим практический пример разработки.</p>
        <h2>Разработка функции возведения в степень — «pow»: спецификация</h2>
        <p>Допустим, мы хотим написать функцию <code>pow(x, n)</code>, которая возводит <code>x</code> в целочисленную степень <code>n</code>. Мы предполагаем, что <code>n≥0</code>.</p>
        <p>Эта задача взята в качестве примера. В JavaScript есть оператор <code>**</code>, который служит для возведения в степень. Мы сосредоточимся на процессе разработки, который также можно применять и для более сложных задач.</p>
        <p>Перед тем, как начать писать код функции <code>pow</code>, мы можем представить себе, что она должна делать, и описать её.</p>
        <p>Такое описание называется <em>спецификацией</em> (specification). Она содержит описания различных способов использования и тесты для них, например:</p>
        <div class="code-example">
          <div class="codebox">
            <div class="line-numbers language-javascript">
              <code class="language-javascript">
<pre>
<code class="token function">describe</code><code class="token punctuation">(</code><code class="token string">"pow"</code><code class="token punctuation">,</code> <code class="token keyword">function</code><code class="token punctuation">(</code><code class="token punctuation">)</code> <code class="token punctuation">{</code>

  <code class="token function">it</code><code class="token punctuation">(</code><code class="token string">"возводит в степень n"</code><code class="token punctuation">,</code> <code class="token keyword">function</code><code class="token punctuation">(</code><code class="token punctuation">)</code> <code class="token punctuation">{</code>
    assert<code class="token punctuation">.</code><code class="token function">equal</code><code class="token punctuation">(</code><code class="token function">pow</code><code class="token punctuation">(</code><code class="token number">2</code><code class="token punctuation">,</code> <code class="token number">3</code><code class="token punctuation">)</code><code class="token punctuation">,</code> <code class="token number">8</code><code class="token punctuation">)</code><code class="token punctuation">;</code>
  <code class="token punctuation">}</code><code class="token punctuation">)</code><code class="token punctuation">;</code>

<code class="token punctuation">}</code><code class="token punctuation">)</code><code class="token punctuation">;</code>
</pre>
              </code>
              <span class="line-numbers-rows">
                <script src="../js/line-numbers-rows.js"></script>
                <script>rowsNumbers(7);</script>
              </span>
            </div>
          </div>
        </div>
        <p>Спецификация состоит из трёх основных блоков:</p>
        <dl>
          <dt><code>describe("заголовок", function() { ... })</code></dt>
          <dd>
            <p>Какую функциональность мы описываем. В нашем случае мы описываем функцию <code>pow</code>. Используется для группировки рабочих лошадок – блоков <code>it</code>.</p>
          </dd>
          <dt><code>it("описание", function() { ... })</code></dt>
          <dd>
            <p>В первом аргументе блока <code>it</code> мы <em>человеческим языком</em> описываем конкретный способ использования функции, а во втором – пишем функцию, которая тестирует данный случай.</p>
          </dd>
          <dt><code>assert.equal(value1, value2)</code></dt>
          <dd>
            <p>Код внутри блока <code>it</code>, если функция работает верно, должен выполняться без ошибок.</p>
            <p>Функции вида <code>assert.*</code> используются для проверки того, что функция <code>pow</code> работает так, как мы ожидаем. В этом примере мы используем одну из них – <code>assert.equal</code>, которая сравнивает переданные значения и выбрасывает ошибку, если они не равны друг другу. Существуют и другие типы сравнений и проверок, которые мы добавим позже.</p>
          </dd>
        </dl>
        <p>Спецификация может быть запущена, и при этом будет выполнена проверка, указанная в блоке <code>it</code>, мы увидим это позднее.</p>
        <h2>Процесс разработки</h2>
        <p>Процесс разработки обычно выглядит следующим образом:</p>
        <ol>
          <li>Пишется начальная спецификация с тестами, проверяющими основную функциональность.</li>
          <li>Создаётся начальная реализация.</li>
          <li>Для запуска тестов мы используем фреймворк <a href="http://mochajs.org/">Mocha</a> (подробнее о нём чуть позже). Пока функция не готова, будут ошибки. Вносим изменения до тех пор, пока всё не начнёт работать так, как нам нужно.</li>
          <li>Теперь у нас есть правильно работающая начальная реализация и тесты.</li>
          <li>Мы добавляем новые способы использования в спецификацию, возможно, ещё не реализованные в тестируемом коде. Тесты начинают «падать» (выдавать ошибки).</li>
          <li>Возвращаемся на шаг 3, дописываем реализацию до тех пор, пока тесты не начнут завершаться без ошибок.</li>
          <li>Повторяем шаги 3-6, пока требуемая функциональность не будет готова.</li>
        </ol>
        <p>Таким образом, разработка проходит <em>итеративно</em>. Мы пишем спецификацию, реализуем её, проверяем, что тесты выполняются без ошибок, пишем ещё тесты, снова проверяем, что они проходят и т.д.</p>
        <p>Давайте посмотрим этот поток разработки на нашем примере.</p>
        <p>Первый шаг уже завершён. У нас есть спецификация для функции <code>pow</code>. Теперь, перед тем, как писать реализацию, давайте подключим библиотеки для пробного запуска тестов, просто чтобы убедиться, что тесты работают (разумеется, они завершатся ошибками).</p>
        <h2>Спецификация в действии</h2>
        <p>В этой главе мы будем пользоваться следующими JavaScript-библиотеками для тестов:</p>
        <ul>
          <li><a href="http://mochajs.org/">Mocha</a> – основной фреймворк. Он предоставляет общие функции тестирования, такие как <code>describe</code> и <code>it</code>, а также функцию запуска тестов.</li>
          <li><a href="http://chaijs.com">Chai</a> – библиотека, предоставляющая множество функций проверки утверждений. Пока мы будем использовать только <code>assert.equal</code>.</li>
          <li><a href="http://sinonjs.org/">Sinon</a> – библиотека, позволяющая наблюдать за функциями, эмулировать встроенные функции и многое другое. Нам она пригодится позднее.</li>
        </ul>
        <p>Эти библиотеки подходят как для тестирования внутри браузера, так и на стороне сервера. Мы рассмотрим вариант с браузером.</p>
        <p>Полная HTML-страница с этими библиотеками и спецификацией функции <code>pow</code>:</p>
        <div class="code-example">
          <div class="codebox">
            <div class="line-numbers language-markup">
              <code class="language-markup">
<pre>
<code class="token doctype">&lt;!DOCTYPE html&gt;</code>
<code class="token tag"><code class="token tag"><code class="token punctuation">&lt;</code>html</code><code class="token punctuation">&gt;</code></code>
<code class="token tag"><code class="token tag"><code class="token punctuation">&lt;</code>head</code><code class="token punctuation">&gt;</code></code>
  <code class="token comment">&lt;!-- добавим стили mocha для отображения результатов --&gt;</code>
  <code class="token tag"><code class="token tag"><code class="token punctuation">&lt;</code>link</code> <code class="token attr-name">rel</code><code class="token attr-value"><code class="token punctuation">=</code><code class="token punctuation">"</code>stylesheet<code class="token punctuation">"</code></code> <code class="token attr-name">href</code><code class="token attr-value"><code class="token punctuation">=</code><code class="token punctuation">"</code>https://cdnjs.cloudflare.com/ajax/libs/mocha/3.2.0/mocha.css<code class="token punctuation">"</code></code><code class="token punctuation">&gt;</code></code>
  <code class="token comment">&lt;!-- добавляем сам фреймворк mocha --&gt;</code>
  <code class="token tag"><code class="token tag"><code class="token punctuation">&lt;</code>script</code> <code class="token attr-name">src</code><code class="token attr-value"><code class="token punctuation">=</code><code class="token punctuation">"</code>https://cdnjs.cloudflare.com/ajax/libs/mocha/3.2.0/mocha.js<code class="token punctuation">"</code></code><code class="token punctuation">&gt;</code></code><code class="token script"></code><code class="token tag"><code class="token tag"><code class="token punctuation">&lt;/</code>script</code><code class="token punctuation">&gt;</code></code>
  <code class="token tag"><code class="token tag"><code class="token punctuation">&lt;</code>script</code><code class="token punctuation">&gt;</code></code><code class="token script"><code class="token language-javascript">
    <code class="token comment">// включаем режим тестирования в стиле BDD</code>
    mocha<code class="token punctuation">.</code><code class="token function">setup</code><code class="token punctuation">(</code><code class="token string">'bdd'</code><code class="token punctuation">)</code><code class="token punctuation">;</code>
  </code></code><code class="token tag"><code class="token tag"><code class="token punctuation">&lt;/</code>script</code><code class="token punctuation">&gt;</code></code>
  <code class="token comment">&lt;!-- добавим chai --&gt;</code>
  <code class="token tag"><code class="token tag"><code class="token punctuation">&lt;</code>script</code> <code class="token attr-name">src</code><code class="token attr-value"><code class="token punctuation">=</code><code class="token punctuation">"</code>https://cdnjs.cloudflare.com/ajax/libs/chai/3.5.0/chai.js<code class="token punctuation">"</code></code><code class="token punctuation">&gt;</code></code><code class="token script"></code><code class="token tag"><code class="token tag"><code class="token punctuation">&lt;/</code>script</code><code class="token punctuation">&gt;</code></code>
  <code class="token tag"><code class="token tag"><code class="token punctuation">&lt;</code>script</code><code class="token punctuation">&gt;</code></code><code class="token script"><code class="token language-javascript">
    <code class="token comment">// chai предоставляет большое количество функций. Объявим assert глобально</code>
    <code class="token keyword">let</code> assert <code class="token operator">=</code> chai<code class="token punctuation">.</code>assert<code class="token punctuation">;</code>
  </code></code><code class="token tag"><code class="token tag"><code class="token punctuation">&lt;/</code>script</code><code class="token punctuation">&gt;</code></code>
<code class="token tag"><code class="token tag"><code class="token punctuation">&lt;/</code>head</code><code class="token punctuation">&gt;</code></code>

<code class="token tag"><code class="token tag"><code class="token punctuation">&lt;</code>body</code><code class="token punctuation">&gt;</code></code>

  <code class="token tag"><code class="token tag"><code class="token punctuation">&lt;</code>script</code><code class="token punctuation">&gt;</code></code><code class="token script"><code class="token language-javascript">
    <code class="token keyword">function</code> <code class="token function">pow</code><code class="token punctuation">(</code><code class="token parameter">x<code class="token punctuation">,</code> n</code><code class="token punctuation">)</code> <code class="token punctuation">{</code>
      <code class="token comment">/* Здесь будет реализация функции, пока пусто */</code>
    <code class="token punctuation">}</code>
  </code></code><code class="token tag"><code class="token tag"><code class="token punctuation">&lt;/</code>script</code><code class="token punctuation">&gt;</code></code>

  <code class="token comment">&lt;!-- скрипт со спецификацией (describe, it...) --&gt;</code>
  <code class="token tag"><code class="token tag"><code class="token punctuation">&lt;</code>script</code> <code class="token attr-name">src</code><code class="token attr-value"><code class="token punctuation">=</code><code class="token punctuation">"</code>test.js<code class="token punctuation">"</code></code><code class="token punctuation">&gt;</code></code><code class="token script"></code><code class="token tag"><code class="token tag"><code class="token punctuation">&lt;/</code>script</code><code class="token punctuation">&gt;</code></code>

  <code class="token comment">&lt;!-- элемент с id="mocha" будет содержать результаты тестов --&gt;</code>
  <code class="token tag"><code class="token tag"><code class="token punctuation">&lt;</code>div</code> <code class="token attr-name">id</code><code class="token attr-value"><code class="token punctuation">=</code><code class="token punctuation">"</code>mocha<code class="token punctuation">"</code></code><code class="token punctuation">&gt;</code></code><code class="token tag"><code class="token tag"><code class="token punctuation">&lt;/</code>div</code><code class="token punctuation">&gt;</code></code>

  <code class="token comment">&lt;!-- запускаем тесты! --&gt;</code>
  <code class="token tag"><code class="token tag"><code class="token punctuation">&lt;</code>script</code><code class="token punctuation">&gt;</code></code><code class="token script"><code class="token language-javascript">
    mocha<code class="token punctuation">.</code><code class="token function">run</code><code class="token punctuation">(</code><code class="token punctuation">)</code><code class="token punctuation">;</code>
  </code></code><code class="token tag"><code class="token tag"><code class="token punctuation">&lt;/</code>script</code><code class="token punctuation">&gt;</code></code>
<code class="token tag"><code class="token tag"><code class="token punctuation">&lt;/</code>body</code><code class="token punctuation">&gt;</code></code>

<code class="token tag"><code class="token tag"><code class="token punctuation">&lt;/</code>html</code><code class="token punctuation">&gt;</code></code>
</pre>
              </code>
              <span class="line-numbers-rows">
                <script src="../js/line-numbers-rows.js"></script>
                <script>rowsNumbers(40);</script>
              </span>
            </div>
          </div>
        </div>
        <p>Условно страницу можно разделить на пять частей:</p>
        <ol>
          <li>Тег <code>&lt;head&gt;</code> содержит сторонние библиотеки и стили для тестов.</li>
          <li>Тег <code>&lt;script&gt;</code> содержит тестируемую функцию, в нашем случае – <code>pow</code>.</li>
          <li>Тесты – в нашем случае внешний скрипт <code>test.js</code>, который содержит спецификацию <code>describe("pow", ...)</code>, представленную выше.</li>
          <li>HTML-элемент <code>&lt;div id="mocha"&gt;</code> будет использован фреймворком Mocha для вывода результатов тестирования.</li>
          <li>Запуск тестов производится командой <code>mocha.run()</code>.</li>
        </ol>
        <p>Результаты:</p>
        <div class="code-result">
          <div class="code-result__toolbar toolbar">
            <div class="toolbar__tool">
              <a href="https://plnkr.co/edit/jIs05hwEnzt5ljQc?p=preview" target="_blank" title="открыть в песочнице" data-plunk-id="jIs05hwEnzt5ljQc" class="toolbar__button toolbar__button_edit"></a>
            </div>
          </div>
          <iframe class="code-result__iframe" data-trusted="1" style="height:250px" src="https://ru.js.cx/article/testing-mocha/pow-1/"></iframe>
        </div>
        <p>Пока что тест завершается ошибкой. Это логично, потому что у нас пустая функция <code>pow</code>, так что <code>pow(2,3)</code> возвращает <code>undefined</code> вместо <code>8</code>.</p>
        <p>На будущее отметим, что существуют более высокоуровневые фреймворки для тестирования, такие как <a href="https://karma-runner.github.io/">karma</a> и другие. С их помощью легко сделать автозапуск множества тестов.</p>
        <h2>Начальная реализация</h2>
        <p>Давайте напишем простую реализацию функции <code>pow</code>, чтобы пройти тесты.</p>
        <div class="code-example">
          <div class="codebox">
            <div class="line-numbers language-javascript">
              <code class="language-javascript">
<pre>
<code class="token keyword">function</code> <code class="token function">pow</code><code class="token punctuation">(</code><code class="token parameter">x<code class="token punctuation">,</code> n</code><code class="token punctuation">)</code> <code class="token punctuation">{</code>
  <code class="token keyword">return</code> <code class="token number">8</code><code class="token punctuation">;</code> <code class="token comment">// :) сжульничаем!</code>
<code class="token punctuation">}</code>
</pre>
              </code>
              <span class="line-numbers-rows">
                <script src="../js/line-numbers-rows.js"></script>
                <script>rowsNumbers(3);</script>
              </span>
            </div>
          </div>
        </div>
        <p>Вау, теперь всё работает!</p>
        <div class="code-result">
          <div class="code-result__toolbar toolbar">
            <div class="toolbar__tool">
              <a href="https://plnkr.co/edit/HuZ4IY63WeDHXGdR?p=preview" target="_blank" title="открыть в песочнице" data-plunk-id="HuZ4IY63WeDHXGdR" class="toolbar__button toolbar__button_edit"></a>
            </div>
          </div>
          <iframe class="code-result__iframe" data-trusted="1" style="height:250px" src="https://ru.js.cx/article/testing-mocha/pow-min/"></iframe>
        </div>
        <h2>Улучшаем спецификацию</h2>
        <p>Конечно, мы сжульничали. Функция не работает. Попытка посчитать <code>pow(3,4)</code> даст некорректный результат, однако тесты проходят.</p>
        <p>…Такая ситуация вполне типична, она случается на практике. Тесты проходят, но функция работает неправильно. Наша спецификация не идеальна. Нужно дополнить её тестами.</p>
        <p>Давайте добавим ещё один тест, чтобы посмотреть, что <code>pow(3, 4) = 81</code>.</p>
        <p>У нас есть два пути организации тестов:</p>
        <ol>
          <li>
            <p>Первый – добавить ещё один <code>assert</code> в существующий <code>it</code>:</p>
            <div class="code-example">
              <div class="codebox">
                <div class="line-numbers language-javascript">
                  <code class="language-javascript">
<pre>
<code class="token function">describe</code><code class="token punctuation">(</code><code class="token string">"pow"</code><code class="token punctuation">,</code> <code class="token keyword">function</code><code class="token punctuation">(</code><code class="token punctuation">)</code> <code class="token punctuation">{</code>

  <code class="token function">it</code><code class="token punctuation">(</code><code class="token string">"возводит число в степень n"</code><code class="token punctuation">,</code> <code class="token keyword">function</code><code class="token punctuation">(</code><code class="token punctuation">)</code> <code class="token punctuation">{</code>
    assert<code class="token punctuation">.</code><code class="token function">equal</code><code class="token punctuation">(</code><code class="token function">pow</code><code class="token punctuation">(</code><code class="token number">2</code><code class="token punctuation">,</code> <code class="token number">3</code><code class="token punctuation">)</code><code class="token punctuation">,</code> <code class="token number">8</code><code class="token punctuation">)</code><code class="token punctuation">;</code>
    assert<code class="token punctuation">.</code><code class="token function">equal</code><code class="token punctuation">(</code><code class="token function">pow</code><code class="token punctuation">(</code><code class="token number">3</code><code class="token punctuation">,</code> <code class="token number">4</code><code class="token punctuation">)</code><code class="token punctuation">,</code> <code class="token number">81</code><code class="token punctuation">)</code><code class="token punctuation">;</code>
  <code class="token punctuation">}</code><code class="token punctuation">)</code><code class="token punctuation">;</code>

<code class="token punctuation">}</code><code class="token punctuation">)</code><code class="token punctuation">;</code>
</pre>
                  </code>
                  <span class="line-numbers-rows">
                    <script src="../js/line-numbers-rows.js"></script>
                    <script>rowsNumbers(8);</script>
                  </span>
                </div>
              </div>
            </div>
          </li>
          <li>
            <p>Второй – написать два теста:</p>
            <div class="code-example">
              <div class="codebox">
                <div class="line-numbers language-javascript">
                  <code class="language-javascript">
<pre>
<code class="token function">describe</code><code class="token punctuation">(</code><code class="token string">"pow"</code><code class="token punctuation">,</code> <code class="token keyword">function</code><code class="token punctuation">(</code><code class="token punctuation">)</code> <code class="token punctuation">{</code>

  <code class="token function">it</code><code class="token punctuation">(</code><code class="token string">"2 в степени 3 будет 8"</code><code class="token punctuation">,</code> <code class="token keyword">function</code><code class="token punctuation">(</code><code class="token punctuation">)</code> <code class="token punctuation">{</code>
    assert<code class="token punctuation">.</code><code class="token function">equal</code><code class="token punctuation">(</code><code class="token function">pow</code><code class="token punctuation">(</code><code class="token number">2</code><code class="token punctuation">,</code> <code class="token number">3</code><code class="token punctuation">)</code><code class="token punctuation">,</code> <code class="token number">8</code><code class="token punctuation">)</code><code class="token punctuation">;</code>
  <code class="token punctuation">}</code><code class="token punctuation">)</code><code class="token punctuation">;</code>

  <code class="token function">it</code><code class="token punctuation">(</code><code class="token string">"3 в степени 4 будет 81"</code><code class="token punctuation">,</code> <code class="token keyword">function</code><code class="token punctuation">(</code><code class="token punctuation">)</code> <code class="token punctuation">{</code>
    assert<code class="token punctuation">.</code><code class="token function">equal</code><code class="token punctuation">(</code><code class="token function">pow</code><code class="token punctuation">(</code><code class="token number">3</code><code class="token punctuation">,</code> <code class="token number">4</code><code class="token punctuation">)</code><code class="token punctuation">,</code> <code class="token number">81</code><code class="token punctuation">)</code><code class="token punctuation">;</code>
  <code class="token punctuation">}</code><code class="token punctuation">)</code><code class="token punctuation">;</code>

<code class="token punctuation">}</code><code class="token punctuation">)</code><code class="token punctuation">;</code>
</pre>
                  </code>
                  <span class="line-numbers-rows">
                    <script src="../js/line-numbers-rows.js"></script>
                    <script>rowsNumbers(11);</script>
                  </span>
                </div>
              </div>
            </div>
          </li>
        </ol>
        <p>Принципиальная разница в том, что когда один из <code>assert</code> выбрасывает ошибку, то выполнение <code>it</code> блока тут же прекращается. Таким образом, если первый <code>assert</code> выбросит ошибку, результат работы второго <code>assert</code> мы уже не узнаем.</p>
        <p>Разделять тесты предпочтительнее, так как мы получаем больше информации о том, что конкретно пошло не так.</p>
        <p>Помимо этого есть одно хорошее правило, которому стоит следовать.</p>
        <p><strong>Один тест проверяет одну вещь.</strong></p>
        <p>Если вы посмотрите на тест и увидите в нём две независимые проверки, то такой тест лучше разделить на два более простых.</p>
        <p>Давайте продолжим со вторым вариантом.</p>
        <p>Результаты:</p>
        <div class="code-result">
          <div class="code-result__toolbar toolbar">
            <div class="toolbar__tool">
              <a href="https://plnkr.co/edit/bkVPLKh4CGlMz8LI?p=preview" target="_blank" title="открыть в песочнице" data-plunk-id="bkVPLKh4CGlMz8LI" class="toolbar__button toolbar__button_edit"></a>
            </div>
          </div>
          <iframe class="code-result__iframe" data-trusted="1" style="height:250px" src="https://ru.js.cx/article/testing-mocha/pow-2/"></iframe>
        </div>
        <p>Как мы и ожидали, второй тест провалился. Естественно, наша функция всегда возвращает <code>8</code>, в то время как <code>assert</code> ожидает <code>81</code>.</p>
        <h2>Улучшаем реализацию</h2>
        <p>Давайте напишем что-то более похожее на функцию возведения в степень, чтобы заставить тесты проходить.</p>
        <div class="code-example">
          <div class="codebox">
            <div class="line-numbers language-javascript">
              <code class="language-javascript">
<pre>
<code class="token keyword">function</code> <code class="token function">pow</code><code class="token punctuation">(</code><code class="token parameter">x<code class="token punctuation">,</code> n</code><code class="token punctuation">)</code> <code class="token punctuation">{</code>
  <code class="token keyword">let</code> result <code class="token operator">=</code> <code class="token number">1</code><code class="token punctuation">;</code>

  <code class="token keyword">for</code> <code class="token punctuation">(</code><code class="token keyword">let</code> i <code class="token operator">=</code> <code class="token number">0</code><code class="token punctuation">;</code> i <code class="token operator">&lt;</code> n<code class="token punctuation">;</code> i<code class="token operator">++</code><code class="token punctuation">)</code> <code class="token punctuation">{</code>
    result <code class="token operator">*=</code> x<code class="token punctuation">;</code>
  <code class="token punctuation">}</code>

  <code class="token keyword">return</code> result<code class="token punctuation">;</code>
<code class="token punctuation">}</code>
</pre>
              </code>
              <span class="line-numbers-rows">
                <script src="../js/line-numbers-rows.js"></script>
                <script>rowsNumbers(9);</script>
              </span>
            </div>
          </div>
        </div>
        <p>Чтобы убедиться, что эта реализация работает нормально, давайте протестируем её на большем количестве значений. Чтобы не писать вручную каждый блок <code>it</code>, мы можем генерировать их в цикле <code>for</code>:</p>
        <div class="code-example">
          <div class="codebox">
            <div class="line-numbers language-javascript">
              <code class="language-javascript">
<pre>
<code class="token function">describe</code><code class="token punctuation">(</code><code class="token string">"pow"</code><code class="token punctuation">,</code> <code class="token keyword">function</code><code class="token punctuation">(</code><code class="token punctuation">)</code> <code class="token punctuation">{</code>

  <code class="token keyword">function</code> <code class="token function">makeTest</code><code class="token punctuation">(</code><code class="token parameter">x</code><code class="token punctuation">)</code> <code class="token punctuation">{</code>
    <code class="token keyword">let</code> expected <code class="token operator">=</code> x <code class="token operator">*</code> x <code class="token operator">*</code> x<code class="token punctuation">;</code>
    <code class="token function">it</code><code class="token punctuation">(</code><code class="token template-string"><code class="token string">`</code><code class="token interpolation"><code class="token interpolation-punctuation punctuation">${</code>x<code class="token interpolation-punctuation punctuation">}</code></code><code class="token string"> в степени 3 будет </code><code class="token interpolation"><code class="token interpolation-punctuation punctuation">${</code>expected<code class="token interpolation-punctuation punctuation">}</code></code><code class="token string">`</code></code><code class="token punctuation">,</code> <code class="token keyword">function</code><code class="token punctuation">(</code><code class="token punctuation">)</code> <code class="token punctuation">{</code>
      assert<code class="token punctuation">.</code><code class="token function">equal</code><code class="token punctuation">(</code><code class="token function">pow</code><code class="token punctuation">(</code>x<code class="token punctuation">,</code> <code class="token number">3</code><code class="token punctuation">)</code><code class="token punctuation">,</code> expected<code class="token punctuation">)</code><code class="token punctuation">;</code>
    <code class="token punctuation">}</code><code class="token punctuation">)</code><code class="token punctuation">;</code>
  <code class="token punctuation">}</code>

  <code class="token keyword">for</code> <code class="token punctuation">(</code><code class="token keyword">let</code> x <code class="token operator">=</code> <code class="token number">1</code><code class="token punctuation">;</code> x <code class="token operator">&lt;=</code> <code class="token number">5</code><code class="token punctuation">;</code> x<code class="token operator">++</code><code class="token punctuation">)</code> <code class="token punctuation">{</code>
    <code class="token function">makeTest</code><code class="token punctuation">(</code>x<code class="token punctuation">)</code><code class="token punctuation">;</code>
  <code class="token punctuation">}</code>

<code class="token punctuation">}</code><code class="token punctuation">)</codecode class="token punctuation">;</code>
</pre>
              </code>
              <span class="line-numbers-rows">
                <script src="../js/line-numbers-rows.js"></script>
                <script>rowsNumbers(14);</script>
              </span>
            </div>
          </div>
        </div>
        <p>Результат:</p>
        <div class="code-result">
          <div class="code-result__toolbar toolbar">
            <div class="toolbar__tool">
              <a href="https://plnkr.co/edit/wkhH774xLQPfpbns?p=preview" target="_blank" title="открыть в песочнице" data-plunk-id="wkhH774xLQPfpbns" class="toolbar__button toolbar__button_edit"></a>
            </div>
          </div>
          <iframe class="code-result__iframe" data-trusted="1" style="height:250px" src="https://ru.js.cx/article/testing-mocha/pow-3/"></iframe>
        </div>
        <h2>Вложенные блоки describe</h2>
        <p>Мы собираемся добавить больше тестов. Однако, перед этим стоит сгруппировать вспомогательную функцию <code>makeTest</code> и цикл <code>for</code>. Нам не нужна функция <code>makeTest</code> в других тестах, она нужна только в цикле <code>for</code>. Её предназначение – проверить, что <code>pow</code> правильно возводит число в заданную степень.</p>
        <p>Группировка производится вложенными блоками <code>describe</code>:</p>
        <div class="code-example">
          <div class="codebox">
            <div class="line-numbers language-javascript">
              <code class="language-javascript">
<pre>
<code class="token function">describe</code><code class="token punctuation">(</code><code class="token string">"pow"</code><code class="token punctuation">,</code> <code class="token keyword">function</code><code class="token punctuation">(</code><code class="token punctuation">)</code> <code class="token punctuation">{</code>

  <code class="token function">describe</code><code class="token punctuation">(</code><code class="token string">"возводит x в степень 3"</code><code class="token punctuation">,</code> <code class="token keyword">function</code><code class="token punctuation">(</code><code class="token punctuation">)</code> <code class="token punctuation">{</code>
  
    <code class="token keyword">function</code> <code class="token function">makeTest</code><code class="token punctuation">(</code><code class="token parameter">x</code><code class="token punctuation">)</code> <code class="token punctuation">{</code>
      <code class="token keyword">let</code> expected <code class="token operator">=</code> x <code class="token operator">*</code> x <code class="token operator">*</code> x<code class="token punctuation">;</code>
      <code class="token function">it</code><code class="token punctuation">(</code><code class="token template-string"><code class="token string">`</code><code class="token interpolation"><code class="token interpolation-punctuation punctuation">${</code>x<code class="token interpolation-punctuation punctuation">}</code></code><code class="token string"> в степени 3 будет </code><code class="token interpolation"><code class="token interpolation-punctuation punctuation">${</code>expected<code class="token interpolation-punctuation punctuation">}</code></code><code class="token string">`</code></code><code class="token punctuation">,</code> <code class="token keyword">function</code><code class="token punctuation">(</code><code class="token punctuation">)</code> <code class="token punctuation">{</code>
        assert<code class="token punctuation">.</code><code class="token function">equal</code><code class="token punctuation">(</code><code class="token function">pow</code><code class="token punctuation">(</code>x<code class="token punctuation">,</code> <code class="token number">3</code><code class="token punctuation">)</code><code class="token punctuation">,</code> expected<code class="token punctuation">)</code><code class="token punctuation">;</code>
      <code class="token punctuation">}</code><code class="token punctuation">)</code><code class="token punctuation">;</code>
    <code class="token punctuation">}</code>
    
    <code class="token keyword">for</code> <code class="token punctuation">(</code><code class="token keyword">let</code> x <code class="token operator">=</code> <code class="token number">1</code><code class="token punctuation">;</code> x <code class="token operator">&lt;=</code> <code class="token number">5</code><code class="token punctuation">;</code> x<code class="token operator">++</code><code class="token punctuation">)</code> <code class="token punctuation">{</code>
      <code class="token function">makeTest</code><code class="token punctuation">(</code>x<code class="token punctuation">)</code><code class="token punctuation">;</code>
    <code class="token punctuation">}</code>
  
  <code class="token punctuation">}</code><code class="token punctuation">)</code><code class="token punctuation">;</code>
  
  <code class="token comment">// ... другие тесты. Можно писать и describe, и it блоки.</code>
<code class="token punctuation">}</code><code class="token punctuation">)</code><code class="token punctuation">;</code>
</pre>
              </code>
              <span class="line-numbers-rows">
                <script src="../js/line-numbers-rows.js"></script>
                <script>rowsNumbers(19);</script>
              </span>
            </div>
          </div>
        </div>
        <p>Вложенные <code>describe</code> образуют новую подгруппу тестов. В результатах мы можем видеть дополнительные отступы в названиях.</p>
        <div class="code-result">
          <div class="code-result__toolbar toolbar">
            <div class="toolbar__tool">
              <a href="https://plnkr.co/edit/jhMPeQaUhLLiCxnJ?p=preview" target="_blank" title="открыть в песочнице" data-plunk-id="jhMPeQaUhLLiCxnJ" class="toolbar__button toolbar__button_edit"></a>
            </div>
          </div>
          <iframe class="code-result__iframe" data-trusted="1" style="height:250px" src="https://ru.js.cx/article/testing-mocha/pow-4/"></iframe>
        </div>
        <p>В будущем мы можем написать новые <code>it</code> и <code>describe</code> блоки на верхнем уровне со своими собственными вспомогательными функциями. Им не будет доступна функция <code>makeTest</code> из примера выше.</p>
        <div class="important important_smart">
          <div class="important__header">
            <span class="important__type"><code>before/after</code> и <code>beforeEach/afterEach</code></span>
          </div>
          <div class="important__content">
            <p>Мы можем задать <code>before/after</code> функции, которые будут выполняться до/после тестов, а также функции <code>beforeEach/afterEach</code>, выполняемые до/после <em>каждого</em> <code>it</code>.</p>
            <p>Например:</p>
            <div class="code-example">
              <div class="codebox">
                <div class="line-numbers language-javascript">
                  <code class="language-javascript">
<pre>
<code class="token function">describe</code><code class="token punctuation">(</code><code class="token string">"тест"</code><code class="token punctuation">,</code> <code class="token keyword">function</code><code class="token punctuation">(</code><code class="token punctuation">)</code> <code class="token punctuation">{</code>

  <code class="token function">before</code><code class="token punctuation">(</code><code class="token punctuation">(</code><code class="token punctuation">)</code> <code class="token operator">=&gt;</code> <code class="token function">alert</code><code class="token punctuation">(</code><code class="token string">"Тестирование началось – перед тестами"</code><code class="token punctuation">)</code><code class="token punctuation">)</code><code class="token punctuation">;</code>
  <code class="token function">after</code><code class="token punctuation">(</code><code class="token punctuation">(</code><code class="token punctuation">)</code> <code class="token operator">=&gt;</code> <code class="token function">alert</code><code class="token punctuation">(</code><code class="token string">"Тестирование закончилось – после всех тестов"</code><code class="token punctuation">)</code><code class="token punctuation">)</code><code class="token punctuation">;</code>

  <code class="token function">beforeEach</code><code class="token punctuation">(</code><code class="token punctuation">(</code><code class="token punctuation">)</code> <code class="token operator">=&gt;</code> <code class="token function">alert</code><code class="token punctuation">(</code><code class="token string">"Перед тестом – начинаем выполнять тест"</code><code class="token punctuation">)</code><code class="token punctuation">)</code><code class="token punctuation">;</code>
  <code class="token function">afterEach</code><code class="token punctuation">(</code><code class="token punctuation">(</code><code class="token punctuation">)</code> <code class="token operator">=&gt;</code> <code class="token function">alert</code><code class="token punctuation">(</code><code class="token string">"После теста – заканчиваем выполнение теста"</code><code class="token punctuation">)</code><code class="token punctuation">)</code><code class="token punctuation">;</code>

  <code class="token function">it</code><code class="token punctuation">(</code><code class="token string">'тест 1'</code><code class="token punctuation">,</code> <code class="token punctuation">(</code><code class="token punctuation">)</code> <code class="token operator">=&gt;</code> <code class="token function">alert</code><code class="token punctuation">(</code><code class="token number">1</code><code class="token punctuation">)</code><code class="token punctuation">)</code><code class="token punctuation">;</code>
  <code class="token function">it</code><code class="token punctuation">(</code><code class="token string">'тест 2'</code><code class="token punctuation">,</code> <code class="token punctuation">(</code><code class="token punctuation">)</code> <code class="token operator">=&gt;</code> <code class="token function">alert</code><code class="token punctuation">(</code><code class="token number">2</code><code class="token punctuation">)</code><code class="token punctuation">)</code><code class="token punctuation">;</code>

<code class="token punctuation">}</code><code class="token punctuation">)</code><code class="token punctuation">;</code>
</pre>
                  </code>
                  <span class="line-numbers-rows">
                    <script src="../js/line-numbers-rows.js"></script>
                    <script>rowsNumbers(12);</script>
                  </span>
                </div>
              </div>
            </div>
            <p>Порядок выполнения будет таким:</p>
            <div class="code-example">
              <div class="codebox">
                <div class="line-numbers language-none">
                  <code class="language-none">
<pre>
Тестирование началось – перед тестами (before)
Перед тестом – начинаем выполнять тест (beforeEach)
1
После теста – заканчиваем выполнение теста (afterEach)
Перед тестом – начинаем выполнять тест (beforeEach)
2
После теста – заканчиваем выполнение теста (afterEach)
Тестирование закончилось – после всех тестов (after)
</pre>
                  </code>
                  <span class="line-numbers-rows">
                    <script src="../js/line-numbers-rows.js"></script>
                    <script>rowsNumbers(8);</script>
                  </span>
                </div>
              </div>
            </div>
            <a class="edit" target="_blank" href="https://plnkr.co/edit/BvndIFoLucB490K0?p=preview">Открыть пример в песочнице.</a><p>Обычно <code>beforeEach/afterEach</code> и <code>before/after</code> используются для инициализации, обнуления счётчиков или чего-нибудь ещё между тестами (или группами тестов).</p>
          </div>
        </div>
        <h2>Расширение спецификации</h2>
        <p>Основная функциональность <code>pow</code> реализована. Первая итерация разработки завершена. Когда мы закончим отмечать и пить шампанское, давайте продолжим работу и улучшим <code>pow</code>.</p>
        <p>Как было сказано, функция <code>pow(x, n)</code> предназначена для работы с целыми положительными значениями <code>n</code>.</p>
        <p>Для обозначения математических ошибок функции JavaScript обычно возвращают <code>NaN</code>. Давайте делать также для некорректных значений <code>n</code>.</p>
        <p>Сначала давайте опишем это поведение в спецификации.</p>
        <div class="code-example">
          <div class="codebox">
            <div class="line-numbers language-javascript">
              <code class="language-javascript">
<pre>
<code class="token function">describe</code><code class="token punctuation">(</code><code class="token string">"pow"</code><code class="token punctuation">,</code> <code class="token keyword">function</code><code class="token punctuation">(</code><code class="token punctuation">)</code> <code class="token punctuation">{</code>

  <code class="token comment">// ...</code>
  
  <code class="token function">it</code><code class="token punctuation">(</code><code class="token string">"для отрицательных n возвращает NaN"</code><code class="token punctuation">,</code> <code class="token keyword">function</code><code class="token punctuation">(</code><code class="token punctuation">)</code> <code class="token punctuation">{</code>
    assert<code class="token punctuation">.</code><code class="token function">isNaN</code><code class="token punctuation">(</code><code class="token function">pow</code><code class="token punctuation">(</code><code class="token number">2</code><code class="token punctuation">,</code> <code class="token operator">-</code><code class="token number">1</code><code class="token punctuation">)</code><code class="token punctuation">)</code><code class="token punctuation">;</code>
  <code class="token punctuation">}</code><code class="token punctuation">)</code><code class="token punctuation">;</code>
  
  <code class="token function">it</code><code class="token punctuation">(</code><code class="token string">"для дробных n возвращает NaN"</code><code class="token punctuation">,</code> <code class="token keyword">function</code><code class="token punctuation">(</code><code class="token punctuation">)</code> <code class="token punctuation">{</code>
    assert<code class="token punctuation">.</code><code class="token function">isNaN</code><code class="token punctuation">(</code><code class="token function">pow</code><code class="token punctuation">(</code><code class="token number">2</code><code class="token punctuation">,</code> <code class="token number">1.5</code><code class="token punctuation">)</code><code class="token punctuation">)</code><code class="token punctuation">;</code>
  <code class="token punctuation">}</code><code class="token punctuation">)</code><code class="token punctuation">;</code>

<code class="token punctuation">}</code><code class="token punctuation">)</code><code class="token punctuation">;</code>
</pre>
              </code>
              <span class="line-numbers-rows">
                <script src="../js/line-numbers-rows.js"></script>
                <script>rowsNumbers(13);</script>
              </span>
            </div>
          </div>
        </div>
        <p>Результаты с новыми тестами:</p>
        <div class="code-result">
          <div class="code-result__toolbar toolbar">
            <div class="toolbar__tool">
              <a href="https://plnkr.co/edit/Ba631CmRkYp333yJ?p=preview" target="_blank" title="открыть в песочнице" data-plunk-id="Ba631CmRkYp333yJ" class="toolbar__button toolbar__button_edit"></a>
            </div>
          </div>
          <iframe class="code-result__iframe" data-trusted="1" style="height:530px" src="https://ru.js.cx/article/testing-mocha/pow-nan/"></iframe>
        </div>
        <p>Новые тесты падают, потому что наша реализация не поддерживает их. Так работает BDD. Сначала мы добавляем тесты, которые падают, а уже потом пишем под них реализацию.</p>
        <div class="important important_smart">
          <div class="important__header">
            <span class="important__type">Другие функции сравнения</span>
          </div>
          <div class="important__content">
            <p>Обратите внимание на <code>assert.isNaN</code>. Это проверка того, что переданное значение равно <code>NaN</code>.</p>
            <p>Библиотека <a href="http://chaijs.com">Chai</a> содержит множество других подобных функций, например:</p>
            <ul>
              <li><code>assert.equal(value1, value2)</code> – проверяет равенство  <code>value1 == value2</code>.</li>
              <li><code>assert.strictEqual(value1, value2)</code> – проверяет строгое равенство <code>value1 === value2</code>.</li>
              <li><code>assert.notEqual</code>, <code>assert.notStrictEqual</code> – проверяет неравенство и строгое неравенство соответственно.</li>
              <li><code>assert.isTrue(value)</code> – проверяет, что <code>value === true</code></li>
              <li><code>assert.isFalse(value)</code> – проверяет, что <code>value === false</code></li>
              <li>…с полным списком можно ознакомиться в <a href="http://chaijs.com/api/assert/">документации</a></li>
            </ul>
          </div>
        </div>
        <p>Итак, нам нужно добавить пару строчек в функцию <code>pow</code>:</p>
        <div class="code-example">
          <div class="codebox">
            <div class="line-numbers language-javascript">
              <code class="language-javascript">
<pre>
<code class="token keyword">function</code> <code class="token function">pow</code><code class="token punctuation">(</code><code class="token parameter">x<code class="token punctuation">,</code> n</code><code class="token punctuation">)</code> <code class="token punctuation">{</code>
  <code class="token keyword">if</code> <code class="token punctuation">(</code>n <code class="token operator">&lt;</code> <code class="token number">0</code><code class="token punctuation">)</code> <code class="token keyword">return</code> <code class="token number">NaN</code><code class="token punctuation">;</code>
  <code class="token keyword">if</code> <code class="token punctuation">(</code>Math<code class="token punctuation">.</code><code class="token function">round</code><code class="token punctuation">(</code>n<code class="token punctuation">)</code> <code class="token operator">!=</code> n<code class="token punctuation">)</code> <code class="token keyword">return</code> <code class="token number">NaN</code><code class="token punctuation">;</code>
  
  <code class="token keyword">let</code> result <code class="token operator">=</code> <code class="token number">1</code><code class="token punctuation">;</code>
  
  <code class="token keyword">for</code> <code class="token punctuation">(</code><code class="token keyword">let</code> i <code class="token operator">=</code> <code class="token number">0</code><code class="token punctuation">;</code> i <code class="token operator">&lt;</code> n<code class="token punctuation">;</code> i<code class="token operator">++</code><code class="token punctuation">)</code> <code class="token punctuation">{</code>
    result <code class="token operator">*=</code> x<code class="token punctuation">;</code>
  <code class="token punctuation">}</code>
  
  <code class="token keyword">return</code> result<code class="token punctuation">;</code>
<code class="token punctuation">}</code>
</pre>
              </code>
              <span class="line-numbers-rows">
                <script src="../js/line-numbers-rows.js"></script>
                <script>rowsNumbers(12);</script>
              </span>
            </div>
          </div>
        </div>
        <p>Теперь работает, все тесты проходят:</p>
        <div class="code-result">
          <div class="code-result__toolbar toolbar">
            <div class="toolbar__tool">
              <a href="https://plnkr.co/edit/yOXxvGChgheXAAmF?p=preview" target="_blank" title="открыть в песочнице" data-plunk-id="yOXxvGChgheXAAmF" class="toolbar__button toolbar__button_edit"></a>
            </div>
          </div>
          <iframe class="code-result__iframe" data-trusted="1" style="height:300px" src="https://ru.js.cx/article/testing-mocha/pow-full/"></iframe>
        </div>
        <a class="edit" target="_blank" href="https://plnkr.co/edit/yOXxvGChgheXAAmF?p=preview">Открыть готовый пример в песочнице.</a>
      </div>
    </div>
  </div>
</body>

</html>